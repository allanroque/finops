---
- name: Collect EC2 instances for region {{ region }}
  amazon.aws.ec2_instance_info:
    region: "{{ region }}"
  register: ec2_instances
  failed_when: false

- name: Collect unused EBS volumes for region {{ region }}
  amazon.aws.ec2_vol_info:
    region: "{{ region }}"
    filters:
      status: available
  register: unused_volumes
  failed_when: false

- name: Collect Elastic IPs for region {{ region }}
  amazon.aws.ec2_eip_info:
    region: "{{ region }}"
  register: eips
  failed_when: false

- name: Collect Load Balancers Target Groups for region {{ region }}
  amazon.aws.elbv2_target_group_info:
    region: "{{ region }}"
  register: target_groups
  failed_when: false
  ignore_errors: true

- name: Collect Auto Scaling Groups for region {{ region }}
  amazon.aws.autoscaling_group_info:
    region: "{{ region }}"
  register: asg_info
  failed_when: false
  ignore_errors: true

- name: Process instances data
  ansible.builtin.set_fact:
    processed_instances: >-
      {%- set instances = [] -%}
      {%- if ec2_instances.instances is defined -%}
        {%- for instance in ec2_instances.instances -%}
          {%- set instance_data = {
            'instance_id': instance.instance_id,
            'instance_type': instance.instance_type,
            'state': instance.state.name,
            'region': region,
            'vpc_id': instance.vpc_id | default('N/A'),
            'subnet_id': instance.subnet_id | default('N/A'),
            'launch_time': instance.launch_time,
            'tags': instance.tags | default({}),
            'name': instance.tags.Name | default('N/A'),
            'owner': instance.tags.owner | default('N/A'),
            'cost_center': instance.tags.CostCenter | default('N/A'),
            'environment': instance.tags.Environment | default('N/A'),
            'os': instance.tags.OS | default('N/A'),
            'platform': instance.platform | default('linux'),
            'architecture': instance.architecture,
            'private_ip': instance.private_ip_address | default('N/A'),
            'public_ip': instance.public_ip_address | default('N/A'),
            'has_required_tags': (
              (instance.tags.Name is defined) and
              (instance.tags.owner is defined) and
              (instance.tags.CostCenter is defined) and
              (instance.tags.Environment is defined)
            )
          } -%}
          {%- set _ = instances.append(instance_data) -%}
        {%- endfor -%}
      {%- endif -%}
      {{ instances }}

- name: Process unused volumes
  ansible.builtin.set_fact:
    processed_volumes: >-
      {%- set volumes = [] -%}
      {%- if unused_volumes.volumes is defined and unused_volumes.volumes is iterable -%}
        {%- for volume in unused_volumes.volumes -%}
          {%- if volume.volume_id is defined -%}
            {%- set volume_data = {
              'volume_id': volume.volume_id,
              'size': volume.size | default(0),
              'volume_type': volume.volume_type | default('unknown'),
              'region': region,
              'create_time': volume.create_time | default('N/A'),
              'tags': volume.tags | default({})
            } -%}
            {%- set _ = volumes.append(volume_data) -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
      {{ volumes }}

- name: Process EIPs
  ansible.builtin.set_fact:
    processed_eips: >-
      {%- set eip_list = [] -%}
      {%- if eips.addresses is defined and eips.addresses is iterable -%}
        {%- for eip in eips.addresses -%}
          {%- if eip.allocation_id is defined -%}
            {%- set eip_data = {
              'allocation_id': eip.allocation_id,
              'public_ip': eip.public_ip | default('N/A'),
              'region': region,
              'instance_id': eip.instance_id | default('N/A'),
              'associated': eip.instance_id is defined and eip.instance_id != ''
            } -%}
            {%- set _ = eip_list.append(eip_data) -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
      {{ eip_list }}

- name: Process Load Balancers
  ansible.builtin.set_fact:
    processed_lbs: >-
      {%- set lbs = [] -%}
      {%- if target_groups.target_groups is defined and target_groups.target_groups is iterable -%}
        {%- for tg in target_groups.target_groups -%}
          {%- if tg.target_group_arn is defined -%}
            {%- set healthy_count = 0 -%}
            {%- if tg.target_health_descriptions is defined and tg.target_health_descriptions is iterable -%}
              {%- for target in tg.target_health_descriptions -%}
                {%- if target.target_health is defined and target.target_health.state is defined -%}
                  {%- if target.target_health.state == 'healthy' -%}
                    {%- set healthy_count = healthy_count + 1 -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {%- set lb_data = {
              'target_group_arn': tg.target_group_arn,
              'target_group_name': tg.target_group_name | default('N/A'),
              'region': region,
              'vpc_id': tg.vpc_id | default('N/A'),
              'protocol': tg.protocol | default('N/A'),
              'port': tg.port | default('N/A'),
              'health_check_enabled': tg.health_check_enabled | default(False),
              'target_health_descriptions': tg.target_health_descriptions | default([]),
              'healthy_targets_count': healthy_count,
              'has_healthy_targets': healthy_count > 0
            } -%}
            {%- set _ = lbs.append(lb_data) -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
      {{ lbs }}

- name: Process Auto Scaling Groups
  ansible.builtin.set_fact:
    processed_asgs: >-
      {%- set asgs = [] -%}
      {%- if asg_info.autoscaling_groups is defined and asg_info.autoscaling_groups is iterable -%}
        {%- for asg in asg_info.autoscaling_groups -%}
          {%- if asg.auto_scaling_group_name is defined -%}
            {%- set min_size = asg.min_size | default(0) | int -%}
            {%- set max_size = asg.max_size | default(0) | int -%}
            {%- set desired = asg.desired_capacity | default(0) | int -%}
            {%- set asg_data = {
              'asg_name': asg.auto_scaling_group_name,
              'region': region,
              'min_size': min_size,
              'max_size': max_size,
              'desired_capacity': desired,
              'instances': asg.instances | default([]),
              'is_empty': (min_size == 0 and max_size == 0) or (desired == 0)
            } -%}
            {%- set _ = asgs.append(asg_data) -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
      {{ asgs }}

- name: Set default empty lists for Load Balancers and ASGs if collection failed
  ansible.builtin.set_fact:
    processed_lbs: []
  when: target_groups is failed or target_groups.target_groups is not defined

- name: Set default empty list for ASGs if collection failed
  ansible.builtin.set_fact:
    processed_asgs: []
  when: asg_info is failed or asg_info.autoscaling_groups is not defined

- name: Aggregate region data
  ansible.builtin.set_fact:
    region_data:
      region: "{{ region }}"
      instances:
        running: "{{ processed_instances | selectattr('state', 'equalto', 'running') | list | length }}"
        stopped: "{{ processed_instances | selectattr('state', 'equalto', 'stopped') | list | length }}"
        total: "{{ processed_instances | length }}"
        details: "{{ processed_instances }}"
      untagged_resources:
        instances: "{{ processed_instances | rejectattr('has_required_tags') | list }}"
      unused_volumes:
        count: "{{ processed_volumes | length }}"
        total_size_gb: "{{ processed_volumes | sum(attribute='size') | default(0) }}"
        details: "{{ processed_volumes }}"
      unused_eips:
        count: "{{ processed_eips | rejectattr('associated') | list | length }}"
        details: "{{ processed_eips | rejectattr('associated') | list }}"
      stopped_instances:
        count: "{{ processed_instances | selectattr('state', 'equalto', 'stopped') | list | length }}"
        details: "{{ processed_instances | selectattr('state', 'equalto', 'stopped') | list }}"
      load_balancers:
        without_healthy_targets: "{{ processed_lbs | default([]) | rejectattr('has_healthy_targets') | list }}"
        details: "{{ processed_lbs | default([]) }}"
      auto_scaling_groups:
        empty: "{{ processed_asgs | default([]) | selectattr('is_empty') | list }}"
        details: "{{ processed_asgs | default([]) }}"

- name: Add region data to global list
  ansible.builtin.set_fact:
    finops_regions_data: "{{ finops_regions_data | default([]) + [region_data] }}"
