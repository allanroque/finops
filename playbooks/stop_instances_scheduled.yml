---
- name: Stop EC2 Instances - Scheduled Shutdown
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    # Lista de IDs de instâncias para parar (opcional)
    instance_ids: "{{ instance_ids | default([]) }}"
    
    # Filtros por tags (usado se instance_ids não for fornecido)
    filter_environment: "{{ filter_environment | default(['dev', 'test', 'sandbox']) }}"
    filter_states: "{{ filter_states | default(['running']) }}"
    
    # Regiões onde buscar instâncias
    regions: "{{ regions | default(['us-east-1', 'us-east-2']) }}"
    
    # Modo de operação: 'list' para apenas listar, 'stop' para parar
    action: "{{ action | default('list') }}"
    
  tasks:
    - name: Display execution parameters
      ansible.builtin.debug:
        msg: |
          Executando parada agendada de instâncias:
          - Action: {{ action }}
          - Instance IDs: {{ instance_ids if instance_ids else 'Nenhum (usando filtros)' }}
          - Filter Environment: {{ filter_environment }}
          - Filter States: {{ filter_states }}
          - Regions: {{ regions }}

    - name: Stop instances by ID list
      block:
        - name: Get instance information by IDs
          amazon.aws.ec2_instance_info:
            region: "{{ item }}"
            instance_ids: "{{ instance_ids }}"
          register: instances_info
          loop: "{{ regions }}"
          when: instance_ids | length > 0

        - name: Filter running instances from ID list
          ansible.builtin.set_fact:
            instances_to_stop: >-
              {%- set instances = [] -%}
              {%- for region_result in instances_info.results -%}
                {%- if region_result.instances is defined -%}
                  {%- for instance in region_result.instances -%}
                    {%- if instance.state.name in filter_states -%}
                      {%- set _ = instances.append({
                        'instance_id': instance.instance_id,
                        'region': region_result.item,
                        'name': instance.tags.Name | default('N/A'),
                        'environment': instance.tags.Environment | default('N/A'),
                        'state': instance.state.name
                      }) -%}
                    {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}
                {%- endfor -%}
              {{ instances }}
          when: instance_ids | length > 0

      when: instance_ids | length > 0

    - name: Stop instances by tag filters
      block:
        - name: Get instances by environment tags
          amazon.aws.ec2_instance_info:
            region: "{{ item.region }}"
            filters:
              "tag:Environment": "{{ item.env }}"
              instance-state-name: "{{ item.state }}"
          register: instances_by_tag
          loop: "{{ regions | product(filter_environment) | product(filter_states) | map('join', ':') | list | map('split', ':') | map('list') | list }}"
          vars:
            region: "{{ item[0] }}"
            env: "{{ item[1] }}"
            state: "{{ item[2] }}"
          when: instance_ids | length == 0

        - name: Compile instances from tag filters
          ansible.builtin.set_fact:
            instances_to_stop: >-
              {%- set instances = [] -%}
              {%- for result in instances_by_tag.results -%}
                {%- if result.instances is defined -%}
                  {%- for instance in result.instances -%}
                    {%- set _ = instances.append({
                      'instance_id': instance.instance_id,
                      'region': result.item[0],
                      'name': instance.tags.Name | default('N/A'),
                      'environment': instance.tags.Environment | default('N/A'),
                      'state': instance.state.name
                    }) -%}
                    {%- endfor -%}
                  {%- endif -%}
                {%- endfor -%}
              {{ instances }}
          when: instance_ids | length == 0

      when: instance_ids | length == 0

    - name: Set default empty list if no instances found
      ansible.builtin.set_fact:
        instances_to_stop: []
      when: instances_to_stop is not defined

    - name: Display instances to stop
      ansible.builtin.debug:
        msg: |
          Instâncias encontradas para parar ({{ instances_to_stop | length }}):
          {%- for inst in instances_to_stop -%}
          - {{ inst.instance_id }} ({{ inst.name }}) - {{ inst.region }} - {{ inst.environment }} - {{ inst.state }}
          {%- endfor -%}

    - name: List only mode - No action taken
      ansible.builtin.debug:
        msg: "MODO LISTA: Nenhuma instância será parada. Defina action=stop para parar as instâncias."
      when: action == 'list'

    - name: Stop instances
      block:
        - name: Stop EC2 instances
          amazon.aws.ec2_instance:
            region: "{{ item.region }}"
            instance_ids:
              - "{{ item.instance_id }}"
            state: stopped
            wait: true
            wait_timeout: 300
          register: stop_result
          loop: "{{ instances_to_stop }}"

        - name: Display stop results
          ansible.builtin.debug:
            msg: "Instância {{ item.item.instance_id }} ({{ item.item.name }}) parada com sucesso em {{ item.item.region }}"
          loop: "{{ stop_result.results }}"
          when: item.changed

        - name: Summary
          ansible.builtin.debug:
            msg: |
              ==========================================
              RESUMO DA PARADA AGENDADA:
              ==========================================
              Total de instâncias encontradas: {{ instances_to_stop | length }}
              Instâncias paradas com sucesso: {{ stop_result.results | selectattr('changed', 'equalto', True) | list | length }}
              Instâncias que já estavam paradas: {{ stop_result.results | selectattr('changed', 'equalto', False) | list | length }}
              ==========================================

      when: action == 'stop' and instances_to_stop | length > 0

    - name: No instances to stop
      ansible.builtin.debug:
        msg: "Nenhuma instância encontrada para parar com os critérios especificados."
      when: instances_to_stop | length == 0
```

Criando um README com instruções de uso:

```markdown:/Users/aroque/Documents/redhat/ansible/projetos/finops/playbooks/README_SCHEDULED.md
# Playbooks de Agendamento de Instâncias EC2

Playbooks para agendar o desligamento e ligamento automático de instâncias EC2 no Automation Controller.

## Playbooks Disponíveis

### 1. `stop_instances_scheduled.yml`
Para instâncias EC2 baseado em critérios configuráveis.

### 2. `start_instances_scheduled.yml`
Inicia instâncias EC2 baseado em critérios configuráveis.

## Configuração no Automation Controller

### Variáveis de Job Template

#### Para STOP (Desligamento - 20h diariamente e fins de semana)

```yaml
action: stop
filter_environment:
  - dev
  - test
  - sandbox
filter_states:
  - running
regions:
  - us-east-1
  - us-east-2
```

#### Para START (Ligamento - 7h dias úteis)

```yaml
action: start
filter_environment:
  - dev
  - test
  - sandbox
filter_states:
  - stopped
regions:
  - us-east-1
  - us-east-2
```

#### Modo Lista (Apenas visualizar, sem executar)

```yaml
action: list
filter_environment:
  - dev
  - test
filter_states:
  - running
regions:
  - us-east-1
  - us-east-2
```

### Usando Lista de Instance IDs Específicas

```yaml
action: stop
instance_ids:
  - i-1234567890abcdef0
  - i-0987654321fedcba0
regions:
  - us-east-1
```

## Agendamento no Automation Controller

### 1. Criar Schedule para STOP (Desligamento)

- **Nome**: `Stop Dev/Test Instances - 20h`
- **Frequência**: Diariamente às 20:00
- **Playbook**: `stop_instances_scheduled.yml`
- **Variáveis**:
  ```yaml
  action: stop
  filter_environment: ['dev', 'test', 'sandbox']
  filter_states: ['running']
  regions: ['us-east-1', 'us-east-2']
  ```

### 2. Criar Schedule para START (Ligamento)

- **Nome**: `Start Dev/Test Instances - 7h Weekdays`
- **Frequência**: Dias úteis (Segunda a Sexta) às 07:00
- **Playbook**: `start_instances_scheduled.yml`
- **Variáveis**:
  ```yaml
  action: start
  filter_environment: ['dev', 'test', 'sandbox']
  filter_states: ['stopped']
  regions: ['us-east-1', 'us-east-2']
  ```

### 3. Schedule para Fins de Semana

- **Nome**: `Stop All Dev/Test - Weekend Start`
- **Frequência**: Sábado às 00:00
- **Playbook**: `stop_instances_scheduled.yml`
- **Variáveis**: Mesmas do STOP diário

- **Nome**: `Start All Dev/Test - Monday Morning`
- **Frequência**: Segunda-feira às 07:00
- **Playbook**: `start_instances_scheduled.yml`
- **Variáveis**: Mesmas do START diário

## Exemplos de Uso

### Teste Manual (Modo Lista)

```bash
ansible-playbook playbooks/stop_instances_scheduled.yml \
  -e "action=list" \
  -e "filter_environment=['dev','test']" \
  -e "filter_states=['running']" \
  -e "regions=['us-east-1']"
```

### Execução Real (Stop)

```bash
ansible-playbook playbooks/stop_instances_scheduled.yml \
  -e "action=stop" \
  -e "filter_environment=['dev','test']" \
  -e "filter_states=['running']" \
  -e "regions=['us-east-1','us-east-2']"
```

### Execução com Lista Específica de IDs

```bash
ansible-playbook playbooks/stop_instances_scheduled.yml \
  -e "action=stop" \
  -e 'instance_ids=["i-1234567890abcdef0","i-0987654321fedcba0"]' \
  -e "regions=['us-east-1']"
```

## Economia Estimada

- **Ambientes Dev/Test**: ~70% de economia
- **Horário comercial**: 8 horas/dia × 5 dias = 40 horas/semana
- **Horas economizadas**: 168 - 40 = 128 horas/semana (76% de economia)
- **Com fins de semana**: 128 + 48 = 176 horas/semana (89% de economia)

## Segurança

- Os playbooks usam `action: list` por padrão para evitar execuções acidentais
- Sempre teste com `action: list` antes de executar `action: stop` ou `action: start`
- Os playbooks respeitam os filtros de estado (não tenta parar instâncias já paradas)

## Notas

- O playbook aguarda até 300 segundos (5 minutos) para cada instância iniciar/parar
- Instâncias são identificadas por tags `Environment` (dev, test, sandbox, prod)
- Instâncias de produção (`prod`) NÃO são afetadas por padrão
- Regiões padrão são `us-east-1` e `us-east-2`
```

## Resumo

Foram criados:
1. `stop_instances_scheduled.yml` — para parar instâncias
2. `start_instances_scheduled.yml` — para iniciar instâncias
3. `README_SCHEDULED.md` — documentação de uso

Funcionalidades:
- Filtro por tags `Environment` (dev, test, sandbox)
- Suporte a lista de IDs específicos
- Modo `list` para visualizar antes de executar
- Suporte a múltiplas regiões
- Resumo de execução
- Segurança: modo `list` por padrão

Use no Automation Controller com agendamentos para automatizar o desligamento/ligamento de instâncias de desenvolvimento e teste.
```

## Resumo

Foram criados:
1. `stop_instances_scheduled.yml` — para parar instâncias
2. `start_instances_scheduled.yml` — para iniciar instâncias
3. `README_SCHEDULED.md` — documentação de uso

Funcionalidades:
- Filtro por tags `Environment` (dev, test, sandbox)
- Suporte a lista de IDs específicos
- Modo `list` para visualizar antes de executar
- Suporte a múltiplas regiões
- Resumo de execução
- Segurança: modo `list` por padrão

Use no Automation Controller com agendamentos para automatizar o desligamento/ligamento de instâncias de desenvolvimento e teste.
