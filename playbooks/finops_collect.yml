---
# Play 1: Preparar ambiente no servidor ansible-1
- name: Prepare environment on ansible-1 server
  hosts: ansible-1
  gather_facts: false
  
  vars:
    output_dir: "/opt/finops/data"
    app_dir: "/opt/finops"
    
  tasks:
    - name: Ensure output directory exists
      ansible.builtin.file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'
      become: true

    - name: Ensure app directory exists
      ansible.builtin.file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'
      become: true

    - name: Ensure pip3 is installed
      package:
        name:
          - python3-pip
        state: present
      become: true

    - name: Install boto3, pandas, streamlit and plotly
      pip:
        name:
          - boto3
          - pandas
          - streamlit
          - plotly
        executable: pip3
      become: true

# Play 2: Coletar dados AWS (executa no execution environment localhost)
- name: Collect FinOps Data for Streamlit Dashboard
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    output_dir: "/opt/finops/data"
    output_file: "{{ output_dir }}/aws_finops_data.json"
    ec2_regions:
      - 'us-east-1'
      - 'us-east-2'
      - 'us-west-1'
      - 'us-west-2'
      - 'ca-central-1'
      - 'ap-south-1'
      - 'ap-southeast-1'
      - 'ap-southeast-2'
      - 'ap-northeast-1'
      - 'ap-northeast-2'
      - 'ap-northeast-3'
      - 'eu-central-1'
      - 'eu-west-1'
      - 'eu-west-2'
      - 'eu-west-3'
      - 'eu-north-1'
      - 'sa-east-1'
    
  tasks:
    - name: Get current timestamp
      ansible.builtin.command: date -u +"%Y-%m-%dT%H:%M:%SZ"
      register: current_timestamp
      changed_when: false
      delegate_to: localhost

    - name: Get AWS account information
      amazon.aws.aws_caller_info:
      register: aws_account_info
      delegate_to: localhost

    - name: Collect FinOps data from all regions
      ansible.builtin.include_role:
        name: "../roles/collect_finops_data"
      vars:
        region: "{{ item }}"
      loop: "{{ ec2_regions }}"

    - name: Compile all collected data
      ansible.builtin.set_fact:
        finops_data:
          account_id: "{{ aws_account_info.account }}"
          account_alias: "{{ aws_account_info.account_alias | default('N/A') }}"
          user_arn: "{{ aws_account_info.arn }}"
          collection_timestamp: "{{ current_timestamp.stdout }}"
          regions: "{{ finops_regions_data | default([]) }}"

    - name: Ensure output directory exists on ansible-1 before saving
      ansible.builtin.file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'
      delegate_to: ansible-1
      become: true

    - name: Save collected data to JSON file on ansible-1
      ansible.builtin.copy:
        content: "{{ finops_data | to_json(indent=2) }}"
        dest: "{{ output_file }}"
        mode: '0644'
      delegate_to: ansible-1
      become: true

    - name: Display summary
      ansible.builtin.debug:
        msg: "FinOps data collected and saved to {{ output_file }} on ansible-1"

# Play 3: Deploy e iniciar aplicação Streamlit no ansible-1
- name: Deploy and start Streamlit application
  hosts: ansible-1
  gather_facts: false
  
  vars:
    app_dir: "/opt/finops"
    streamlit_app: "{{ app_dir }}/streamlit_app.py"
    streamlit_port: 8501
    
  tasks:
    - name: Copy streamlit_app.py to ansible-1
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../streamlit_app.py"
        dest: "{{ streamlit_app }}"
        mode: '0644'
      become: true

    - name: Check if Streamlit is already running
      ansible.builtin.shell: |
        ps aux | grep -E "streamlit.*8501" | grep -v grep || echo "not_running"
      register: streamlit_status
      changed_when: false
      failed_when: false

    - name: Stop existing Streamlit process if running
      ansible.builtin.shell: |
        pkill -f "streamlit.*8501" || true
      become: true
      when: streamlit_status.stdout != "not_running"
      failed_when: false

    - name: Wait for process to stop
      ansible.builtin.pause:
        seconds: 2
      when: streamlit_status.stdout != "not_running"

    - name: Start Streamlit application in background
      ansible.builtin.shell: |
        cd {{ app_dir }}
        nohup streamlit run {{ streamlit_app }} --server.port {{ streamlit_port }} --server.address 0.0.0.0 > /tmp/streamlit.log 2>&1 &
        echo $!
      register: streamlit_pid
      changed_when: true

    - name: Wait for Streamlit to start
      ansible.builtin.pause:
        seconds: 3

    - name: Verify Streamlit is running
      ansible.builtin.shell: |
        ps aux | grep -E "streamlit.*8501" | grep -v grep
      register: streamlit_check
      changed_when: false
      failed_when: streamlit_check.rc != 0

    - name: Display Streamlit status
      ansible.builtin.debug:
        msg: "Streamlit application started successfully on port {{ streamlit_port }}. Access at http://{{ inventory_hostname }}:{{ streamlit_port }}"
      when: streamlit_check.rc == 0
