---
# Play 1: Preparar ambiente no servidor ansible-1
- name: Prepare environment on ansible-1 server
  hosts: ansible-1
  gather_facts: false
  
  vars:
    output_dir: "{{ playbook_dir }}/../data"
    
  tasks:
    - name: Ensure output directory exists
      ansible.builtin.file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'

    - name: Ensure pip3 is installed
      package:
        name:
          - python3-pip
        state: present
      become: true

    - name: Install boto3 and pandas
      pip:
        name:
          - boto3
          - pandas
        executable: pip3

# Play 2: Coletar dados AWS (executa no execution environment localhost)
- name: Collect FinOps Data for Streamlit Dashboard
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    output_dir: "{{ playbook_dir }}/../data"
    output_file: "{{ output_dir }}/aws_finops_data.json"
    ec2_regions:
      - 'us-east-1'
      - 'us-east-2'
      - 'us-west-1'
      - 'us-west-2'
      - 'ca-central-1'
      - 'ap-south-1'
      - 'ap-southeast-1'
      - 'ap-southeast-2'
      - 'ap-northeast-1'
      - 'ap-northeast-2'
      - 'ap-northeast-3'
      - 'eu-central-1'
      - 'eu-west-1'
      - 'eu-west-2'
      - 'eu-west-3'
      - 'eu-north-1'
      - 'sa-east-1'
    
  tasks:
    - name: Get AWS account information
      amazon.aws.aws_caller_info:
      register: aws_account_info
      delegate_to: localhost

    - name: Collect FinOps data from all regions
      ansible.builtin.include_role:
        name: "../roles/collect_finops_data"
      vars:
        region: "{{ item }}"
      loop: "{{ ec2_regions }}"

    - name: Compile all collected data
      ansible.builtin.set_fact:
        finops_data:
          account_id: "{{ aws_account_info.account }}"
          account_alias: "{{ aws_account_info.account_alias | default('N/A') }}"
          user_arn: "{{ aws_account_info.arn }}"
          collection_timestamp: "{{ ansible_date_time.iso8601 }}"
          regions: "{{ finops_regions_data | default([]) }}"

    - name: Save collected data to JSON file on ansible-1
      ansible.builtin.copy:
        content: "{{ finops_data | to_json(indent=2) }}"
        dest: "{{ output_file }}"
        mode: '0644'
      delegate_to: ansible-1

    - name: Display summary
      ansible.builtin.debug:
        msg: "FinOps data collected and saved to {{ output_file }} on ansible-1"
