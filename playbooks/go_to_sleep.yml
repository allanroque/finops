---
- name: Go to Sleep - Stop EC2 Instances
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    # Valores padrão (podem ser sobrescritos via extra-vars)
    instance_ids_default: []
    filter_environment_default: ['lab', 'test', 'sandbox']
    specific_instance_names_default: ['rhel-5']
    regions_default: ['us-east-1', 'us-east-2']
    
  tasks:
    - name: Set variables with defaults
      ansible.builtin.set_fact:
        instance_ids: "{{ instance_ids | default(instance_ids_default) }}"
        filter_environment: "{{ filter_environment | default(filter_environment_default) }}"
        specific_instance_names: "{{ specific_instance_names | default(specific_instance_names_default) }}"
        regions: "{{ regions | default(regions_default) }}"

    - name: Display execution parameters
      ansible.builtin.debug:
        msg: |
          Desligando instâncias EC2:
          - Instance IDs: {{ instance_ids if instance_ids | length > 0 else 'Nenhum (usando filtros)' }}
          - Filter Environment: {{ filter_environment }}
          - Specific Instance Names: {{ specific_instance_names }}
          - Regions: {{ regions }}

    - name: Get instances to stop by ID list
      block:
        - name: Get instance information by IDs
          amazon.aws.ec2_instance_info:
            region: "{{ item }}"
            instance_ids: "{{ instance_ids }}"
          register: instances_by_id
          loop: "{{ regions }}"
          when: instance_ids | length > 0

        - name: Compile instances from ID list
          ansible.builtin.set_fact:
            instances_to_stop_from_ids: >-
              {%- set instances = [] -%}
              {%- for result in instances_by_id.results -%}
                {%- if result.instances is defined -%}
                  {%- for instance in result.instances -%}
                    {%- if instance.state.name | lower == 'running' -%}
                      {%- set _ = instances.append({
                        'instance_id': instance.instance_id,
                        'region': result.item,
                        'name': instance.tags.Name | default('N/A'),
                        'environment': instance.tags.Environment | default('N/A'),
                        'state': instance.state.name
                      }) -%}
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}
              {%- endfor -%}
              {{ instances }}
          when: instance_ids | length > 0

      when: instance_ids | length > 0

    - name: Get instances to stop by environment tags
      block:
        - name: Get instances by environment tags
          amazon.aws.ec2_instance_info:
            region: "{{ item }}"
            filters:
              "tag:Environment": "{{ filter_environment }}"
              instance-state-name: running
          register: instances_by_env
          loop: "{{ regions }}"
          when: instance_ids | length == 0

        - name: Compile instances from environment tags
          ansible.builtin.set_fact:
            instances_to_stop_from_env: >-
              {%- set instances = [] -%}
              {%- for result in instances_by_env.results -%}
                {%- if result.instances is defined -%}
                  {%- for instance in result.instances -%}
                    {%- set _ = instances.append({
                      'instance_id': instance.instance_id,
                      'region': result.item,
                      'name': instance.tags.Name | default('N/A'),
                      'environment': instance.tags.Environment | default('N/A'),
                      'state': instance.state.name
                    }) -%}
                  {%- endfor -%}
                {%- endif -%}
              {%- endfor -%}
              {{ instances }}
          when: instance_ids | length == 0

      when: instance_ids | length == 0

    - name: Get specific instances by name
      block:
        - name: Get instances by specific names
          amazon.aws.ec2_instance_info:
            region: "{{ item.0 }}"
            filters:
              "tag:Name": "{{ item.1 }}"
              instance-state-name: running
          register: instances_by_name
          loop: "{{ regions | product(specific_instance_names) | list }}"
          when: instance_ids | length == 0

        - name: Compile instances from specific names
          ansible.builtin.set_fact:
            instances_to_stop_from_names: >-
              {%- set instances = [] -%}
              {%- for result in instances_by_name.results -%}
                {%- if result.instances is defined -%}
                  {%- for instance in result.instances -%}
                    {%- set _ = instances.append({
                      'instance_id': instance.instance_id,
                      'region': result.item[0],
                      'name': instance.tags.Name | default('N/A'),
                      'environment': instance.tags.Environment | default('N/A'),
                      'state': instance.state.name
                    }) -%}
                  {%- endfor -%}
                {%- endif -%}
              {%- endfor -%}
              {{ instances }}
          when: instance_ids | length == 0

      when: instance_ids | length == 0

    - name: Combine all instances to stop (remove duplicates)
      ansible.builtin.set_fact:
        instances_to_stop: >-
          {%- set all_instances = [] -%}
          {%- set seen_ids = [] -%}
          {%- if instances_to_stop_from_ids is defined -%}
            {%- for inst in instances_to_stop_from_ids -%}
              {%- if inst.instance_id not in seen_ids -%}
                {%- set _ = all_instances.append(inst) -%}
                {%- set _ = seen_ids.append(inst.instance_id) -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
          {%- if instances_to_stop_from_env is defined -%}
            {%- for inst in instances_to_stop_from_env -%}
              {%- if inst.instance_id not in seen_ids -%}
                {%- set _ = all_instances.append(inst) -%}
                {%- set _ = seen_ids.append(inst.instance_id) -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
          {%- if instances_to_stop_from_names is defined -%}
            {%- for inst in instances_to_stop_from_names -%}
              {%- if inst.instance_id not in seen_ids -%}
                {%- set _ = all_instances.append(inst) -%}
                {%- set _ = seen_ids.append(inst.instance_id) -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
          {{ all_instances }}

    - name: Set default empty list if no instances found
      ansible.builtin.set_fact:
        instances_to_stop: []
      when: instances_to_stop is not defined

    - name: Display instances that will be stopped
      ansible.builtin.debug:
        msg: |
          Instâncias que serão desligadas ({{ instances_to_stop | length }}):
          {%- for inst in instances_to_stop -%}
          - {{ inst.instance_id }} ({{ inst.name }}) - {{ inst.region }} - {{ inst.environment }}
          {%- endfor -%}

    - name: Stop EC2 instances
      block:
        - name: Stop instances
          amazon.aws.ec2_instance:
            region: "{{ item.region }}"
            instance_ids:
              - "{{ item.instance_id }}"
            state: stopped
            wait: true
            wait_timeout: 300
          register: stop_result
          loop: "{{ instances_to_stop }}"

        - name: Display stop results
          ansible.builtin.debug:
            msg: "✅ Instância {{ item.item.instance_id }} ({{ item.item.name }}) desligada com sucesso em {{ item.item.region }}"
          loop: "{{ stop_result.results }}"
          when: item.changed

        - name: Display already stopped instances
          ansible.builtin.debug:
            msg: "ℹ️  Instância {{ item.item.instance_id }} ({{ item.item.name }}) já estava desligada em {{ item.item.region }}"
          loop: "{{ stop_result.results }}"
          when: not item.changed

        - name: Summary
          ansible.builtin.debug:
            msg: |
              ==========================================
              RESUMO - GO TO SLEEP:
              ==========================================
              Total de instâncias encontradas: {{ instances_to_stop | length }}
              Instâncias desligadas com sucesso: {{ stop_result.results | selectattr('changed', 'equalto', True) | list | length }}
              Instâncias que já estavam desligadas: {{ stop_result.results | selectattr('changed', 'equalto', False) | list | length }}
              ==========================================

      when: instances_to_stop | length > 0

    - name: No instances to stop
      ansible.builtin.debug:
        msg: "ℹ️  Nenhuma instância em execução encontrada para desligar com os critérios especificados."
      when: instances_to_stop | length == 0
